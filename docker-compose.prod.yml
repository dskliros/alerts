services:
  alerts:
    image: events-alerts:latest
    build: .
    container_name: alerts-app
    
    # Non-secret configuration from file (easy to modify)
    env_file:
      - .env.prod
    
    # Secrets for credentials only
    secrets:
      # SSH Configuration
      - ssh_host
      - ssh_port
      - ssh_user
      - ssh_ubuntu_key_content
      - ssh_key_content
      
      # Database Configuration
      - db_host
      - db_port
      - db_name
      - db_user
      - db_pass
      
      # SMTP Configuration
      - smtp_host
      - smtp_port
      - smtp_user
      - smtp_pass
      
      # Teams Configuration (webhook contains sensitive token)
      - teams_webhook_url
    
    volumes:
      # Mount logs directory for persistence
      - ./logs:/app/logs
      
      # Mount data directory for sent_events.json persistence
      - ./data:/app/data
      
      # Mount queries directory for easy SQL updates without rebuild
      - ./queries:/app/queries
      
      # Mount media directory for logos
      - ./media:/app/media
    
    # Restart policy for production
    restart: unless-stopped
    
    # Health check to ensure application is working
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.path.insert(0, '/app'); from src.db_utils import check_db_connection; sys.exit(0 if check_db_connection() else 1)"]
      interval: 5m
      timeout: 30s
      retries: 3
      start_period: 40s
    
    # Resource limits (optional - adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    
    # Optional: Run on a schedule using cron-like functionality
    # Uncomment and modify if you want scheduled execution
    # command: sh -c "while true; do python src/events_alerts.py && sleep 3600; done"

# Define secrets - these reference external secrets created via docker secret create
secrets:
  # SSH Secrets
  ssh_host:
    external: true
  ssh_port:
    external: true
  ssh_user:
    external: true
  ssh_ubuntu_key_content:
    external: true
  ssh_key_content:
    external: true
  
  # Database Secrets
  db_host:
    external: true
  db_port:
    external: true
  db_name:
    external: true
  db_user:
    external: true
  db_pass:
    external: true
  
  # SMTP Secrets
  smtp_host:
    external: true
  smtp_port:
    external: true
  smtp_user:
    external: true
  smtp_pass:
    external: true
  
  # Teams Secrets (webhook URL contains sensitive token)
  teams_webhook_url:
    external: true
